<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>운송 확인</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ✅ 배송 상세 정보 모달 표시
        function showDetail(transpNo, itemName, qty, departure, destination, status) {
            document.getElementById("modalTranspNo").textContent = transpNo;
            document.getElementById("modalItemName").textContent = itemName;
            document.getElementById("modalQty").textContent = qty;
            document.getElementById("modalDeparture").textContent = departure;
            document.getElementById("modalDestination").textContent = destination;
            document.getElementById("modalStatus").textContent = status;

            const completeButton = document.getElementById("completeDeliveryButton");

            // 만약 상태가 "배송 완료"라면 버튼 숨기기
            if (status === "배송 완료") {
                completeButton.style.display = "none";
            } else {
                completeButton.style.display = "block";  // 버튼 다시 표시
                completeButton.setAttribute("onclick", `completeDelivery(${transpNo})`);
            }

            var detailModal = new bootstrap.Modal(document.getElementById("detailModal"));
            detailModal.show();
        }

        // ✅ 배송 완료 처리
        function completeDelivery(transpNo) {
            if (!confirm("정말 배송을 완료하시겠습니까?")) return;

            // 서버로 상태 업데이트 요청 (AJAX)
            fetch(`/updateDeliveryStatus/${transpNo}/배송 완료`, { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);

                    // ✅ 모달에서 상태를 즉시 변경
                    document.getElementById("modalStatus").textContent = "배송 완료";

                    // ✅ "배송 완료" 버튼 숨기기
                    document.getElementById("completeDeliveryButton").style.display = "none";
                })
                .catch(error => console.error("Error:", error));
        }

    </script>

    <style>
        .modal-dialog { max-width: 90%; width: 90%; }
        .modal-body { max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>
<main class="container my-2">
    <div class="text-center">
        <h2 class="my-4">운송 확인</h2>
    </div>
        <!-- 검색 필터 -->
        <div class="row mb-3">
            <div class="col-lg-2 my-1">
                <select class="form-select">
                    <option selected>전체</option>
                    <option value="운송 번호">운송 번호</option>
                    <option value="출발지">출발지</option>
                    <option value="도착지">도착지</option>
                    <option value="운송 상태">운송 상태</option>
                </select>
            </div>
            <div class="col-lg-4 my-1">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="">
                    <button class="btn btn-success">검색</button>
                    </div>
            </div>
                <div class="col-lg-3 my-1"></div>
                <div class="col-lg-3 my-1 text-end">
                    <h5>감자 기사님</h5>
                </div>
            </div>
        </div>

        <!-- 배송 목록 -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                <tr class="text-center">
                    <th>운송 번호</th>
                    <th>출발지</th>
                    <th>도착지</th>
                    <th>운송 상태</th>
                </tr>
                </thead>
                <tbody>
                <!-- ✅ 배송 기사에게 배정된 운송 목록 -->
                <tr onclick="showDetail(2001, '노트북', '5', '서울', '부산', '배송 준비 중')" style="cursor: pointer;">
                    <td>2001</td>
                    <td>서울</td>
                    <td>부산</td>
                    <td><span class="badge bg-primary">배송 준비 중</span></td>
                </tr>
                <tr onclick="showDetail(2002, 'TV', '2', '인천', '대전', '배송 중')" style="cursor: pointer;">
                    <td>2002</td>
                    <td>인천</td>
                    <td>대전</td>
                    <td><span class="badge bg-warning">배송 중</span></td>
                </tr>
                <tr onclick="showDetail(2003, '냉장고', '1', '광주', '울산', '배송 완료')" style="cursor: pointer;">
                    <td>2003</td>
                    <td>광주</td>
                    <td>울산</td>
                    <td><span class="badge bg-success">배송 완료</span></td>
                </tr>
                </tbody>
            </table>
        </div>

    <!-- ✅ 상세 정보 모달 -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">운송 상세 정보</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                        <tr class="text-center">
                            <th>운송 번호</th>
                            <th>품목 이름</th>
                            <th>품목 수량</th>
                            <th>출발지</th>
                            <th>도착지</th>
                            <th>운송 상태</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td id="modalTranspNo"></td>
                            <td id="modalItemName"></td>
                            <td id="modalQty"></td>
                            <td id="modalDeparture"></td>
                            <td id="modalDestination"></td>
                            <td id="modalStatus"></td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- ✅ "배송 완료" 버튼 -->
                    <div class="text-center mt-3">
                        <button id="completeDeliveryButton" class="btn btn-success" onclick="completeDelivery()">배송 완료</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

</main>
</body>
</html>
